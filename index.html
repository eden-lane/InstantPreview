<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript">
    var CLIENT_ID_LOCAL = '759755084920-c51okm6pqpqk426u5k3crhe4k7bch8g3.apps.googleusercontent.com';
    var CLIENT_ID_DEV = '759755084920-e9ct1r1gcrp10od5q4ab9uclcarmjt68.apps.googleusercontent.com'
    var SCOPES = ['https://www.googleapis.com/auth/drive.metadata.readonly',
                'https://www.googleapis.com/auth/drive.install',
                'https://www.googleapis.com/auth/drive.file',
                'profile'];

    function checkAuth() {
        gapi.auth.authorize({
            'client_id': CLIENT_ID_DEV,
            'scope': SCOPES.join(' '),
            'immediate': true
        }, handleAuthResult);
    }

    function handleAuthResult(authResult) {
        console.info(authResult)
        var authorizeDiv = document.getElementById('authorize-div');
        if (authResult && !authResult.error) {
            loadDriveApi();
        }
    }

    function handleAuthClick(event) {
        gapi.auth.authorize({
            client_id: CLIENT_ID_DEV, 
            scope: SCOPES, 
            immediate: false
        }, handleAuthResult);
        return false;
    }

    function loadDriveApi() {
        gapi.client.load('drive', 'v2', openFile);
    }   

    function openFile () {
        if (location.href.split('?').length < 2)
            return;
        var id = location.href.split('?')[1].split('=')[1];
        var request = gapi.client.drive.files.get({
            fileId: id
        });
        request.execute(function (response) {
            var url = response.webContentLink.replace('download', 'open');
            location.href = url;
        })
    }

    function downloadFile(url, callback) {
      if (url) {
        var accessToken = gapi.auth.getToken().access_token;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.onload = function() {
          callback(xhr.responseText);
        };
        xhr.onerror = function() {
          callback(null);
        };
        xhr.send();
      } else {
        callback(null);
      }
    }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>

    <title>Instant Preview</title>
</head>
<body>
    <button id="authorize-button" onclick="handleAuthClick(event)">Authorize</button>
    <img id="image"/>
</body>
</html>